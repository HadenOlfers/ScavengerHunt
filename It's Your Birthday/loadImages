import PhotosUI
import UIKit

func loadImages(from photoItems: [PhotosPickerItem], completion: @escaping ([UIImage]) -> Void) {
    var images: [UIImage] = []
    let dispatchGroup = DispatchGroup()

    for photoItem in photoItems {
        dispatchGroup.enter()

        let requestOptions = PHImageRequestOptions()
        requestOptions.isSynchronous = false

        PHImageManager.default().requestImage(for: photoItem.itemIdentifier, targetSize: PHImageManagerMaximumSize, contentMode: .default, options: requestOptions) { (image, _) in
            if let image = image {
                images.append(image)
            }

            dispatchGroup.leave()
        }
    }

    dispatchGroup.notify(queue: DispatchQueue.main) {
        completion(images)
    }
}
